"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[981],{9981:function(oe,H,n){n.d(H,{Z:function(){return ue}});var W=n(64599),Z=n.n(W),K=n(15009),o=n.n(K),Q=n(99289),v=n.n(Q),L=n(12444),V=n.n(L),X=n(72004),x=n.n(X),q=n(25098),w=n.n(q),_=n(31996),ee=n.n(_),te=n(26037),ae=n.n(te),se=n(12665),re=n.n(se),ne=n(9783),I=n.n(ne),m=n(88001),O={titleGeneratorModel:"gpt-4o-mini",titleGeneratorPrompt:"You are a conversation management robot. What the user will send to you is the details of the conversation between the user and an AI. You need to generate a short title that can summarize the content based on the content of the conversation. Output only text, without quotes and markdown format"},ie=n(57632),u=n(41467),he=function(le){ee()(D,le);var de=ae()(D);function D(l){var t;return V()(this,D),t=de.call(this),I()(w()(t),"id",void 0),I()(w()(t),"chat",void 0),I()(w()(t),"botId",void 0),I()(w()(t),"messages",[]),l?t.id=l:t.id=(0,ie.Z)(),t}return x()(D,[{key:"setId",value:function(t){this.id=t}},{key:"setBot",value:function(t){this.botId=t}},{key:"init",value:function(){var l=v()(o()().mark(function d(r,e){var a,i,p;return o()().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,u.db.getData("Chats",this.id);case 2:if(this.chat=h.sent,!(this.chat===null||this.chat===void 0)){h.next=15;break}if(this.chat={id:this.id,title:r===u.z.GenerateBot?"Generate Bot":"",createdAt:new Date,systemPrompt:r===u.z.GenerateBot?m.Qj:"",type:r||u.z.Chat,model:r===u.z.GenerateBot?e||m.K4:e||m.pk,maxDisplayRounds:r===u.z.GenerateBot?100:m.xf,maxMemoryRounds:r===u.z.GenerateBot?100:m.DI},!(this.botId&&this.chat.type===u.z.Chat)){h.next=11;break}return this.chat.botId=this.botId,h.next=9,u.db.getData("Bots",this.botId);case 9:a=h.sent,a&&(this.chat.systemPrompt=a.systemPrompt,this.chat.model=a.model,this.chat.maxDisplayRounds=a.maxDisplayRounds,this.chat.maxMemoryRounds=a.maxMemoryRounds);case 11:return h.next=13,u.db.addData("Chats",this.chat);case 13:h.next=20;break;case 15:return this.chat.maxDisplayRounds=((i=this.chat)===null||i===void 0?void 0:i.maxDisplayRounds)||m.xf,this.chat.maxMemoryRounds=((p=this.chat)===null||p===void 0?void 0:p.maxMemoryRounds)||m.DI,h.next=19,u.db.getAllDataByIndex("Messages","chatId",this.id);case 19:this.messages=h.sent.slice(-this.chat.maxDisplayRounds*2);case 20:case"end":return h.stop()}},d,this)}));function t(d,r){return l.apply(this,arguments)}return t}()},{key:"changeModel",value:function(){var l=v()(o()().mark(function d(r){return o()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.chat){a.next=2;break}throw new Error("Chat is not initialized");case 2:return this.chat.model=r,a.next=5,u.db.updateData("Chats",this.chat);case 5:case"end":return a.stop()}},d,this)}));function t(d){return l.apply(this,arguments)}return t}()},{key:"renameChat",value:function(){var l=v()(o()().mark(function d(r){return o()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.chat){a.next=2;break}throw new Error("Chat is not initialized");case 2:return this.chat.title=r,a.next=5,u.db.updateData("Chats",this.chat);case 5:case"end":return a.stop()}},d,this)}));function t(d){return l.apply(this,arguments)}return t}()},{key:"deleteChat",value:function(){var l=v()(o()().mark(function d(){return o()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.chat){e.next=2;break}throw new Error("Chat is not initialized");case 2:return e.next=4,u.db.deleteData("Chats",this.chat.id);case 4:return e.next=6,u.db.deleteDataByIndex("Messages","chatId",this.chat.id);case 6:case"end":return e.stop()}},d,this)}));function t(){return l.apply(this,arguments)}return t}()},{key:"sendMessage",value:function(){var l=v()(o()().mark(function d(r){var e,a,i,p=this,g,h,M,c,f,P,T,A,R,E,$,J,U,Y,k,j,F,G;return o()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(h=JSON.parse(localStorage.getItem("openai_config")||"{}"),this.chat){s.next=3;break}throw new Error("Chat is not initialized");case 3:return M={chatId:this.chat.id,content:r,createdAt:new Date,isUser:!0},this.messages.push(M),this.messages.length>(((e=this.chat)===null||e===void 0?void 0:e.maxMemoryRounds)||m.DI)*2&&this.messages.shift(),s.next=8,u.db.addData("Messages",M);case 8:return c=[{role:"system",content:this.chat.systemPrompt}],this.messages.slice(-(((a=this.chat)===null||a===void 0?void 0:a.maxMemoryRounds)||m.DI)*2).forEach(function(z){c.push({role:z.isUser?"user":"assistant",content:z.content})}),f={url:"".concat(h.end_point,"/v1/chat/completions"),method:"POST",headers:{},body:JSON.stringify({model:this.chat.model,messages:c,stream:!0})},f.url.match("azure")?(f.url=h.end_point,f.headers={"Content-Type":"application/json","api-key":h.api_key}):f.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(h.api_key)},s.next=14,fetch(f.url,{method:f.method,headers:f.headers,body:f.body});case 14:P=s.sent,T=(i=P.body)===null||i===void 0?void 0:i.getReader(),A=new TextDecoder("utf-8"),R="";case 18:return s.next=21,T.read();case 21:if(E=s.sent,$=E.done,J=E.value,!$){s.next=26;break}return s.abrupt("break",48);case 26:U=A.decode(J,{stream:!0}),Y=U.split(`
`),k=Z()(Y),s.prev=29,F=o()().mark(function z(){var S,N,y,B;return o()().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(S=j.value,!S.startsWith("data: ")){b.next=9;break}if(N=S.slice(6),N!=="[DONE]"){b.next=6;break}return p.dispatchEvent(new CustomEvent("messageReceivedDone",{detail:R})),b.abrupt("return",1);case 6:y=function(){try{return JSON.parse(N)}catch(C){return{}}}(),B=function(){if(y!=null&&y.choices){var C;return y==null||(C=y.choices[0])===null||C===void 0||(C=C.delta)===null||C===void 0?void 0:C.content}return null}(),B&&(R+=B,p.dispatchEvent(new CustomEvent("messageReceived",{detail:B})));case 9:case"end":return b.stop()}},z)}),k.s();case 32:if((j=k.n()).done){s.next=38;break}return s.delegateYield(F(),"t0",34);case 34:if(!s.t0){s.next=36;break}return s.abrupt("break",38);case 36:s.next=32;break;case 38:s.next=43;break;case 40:s.prev=40,s.t1=s.catch(29),k.e(s.t1);case 43:return s.prev=43,k.f(),s.finish(43);case 46:s.next=18;break;case 48:return G={chatId:this.chat.id,content:R,createdAt:new Date,isUser:!1},this.messages.push(G),this.messages.length>(((g=this.chat)===null||g===void 0?void 0:g.maxMemoryRounds)||m.DI)*2&&this.messages.shift(),s.next=53,u.db.addData("Messages",G);case 53:case"end":return s.stop()}},d,this,[[29,40,43,46]])}));function t(d){return l.apply(this,arguments)}return t}()},{key:"deleteMessage",value:function(){var l=v()(o()().mark(function d(r){var e;return o()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(e=this.messages.find(function(p){return p.id===r}),e){i.next=3;break}return i.abrupt("return");case 3:return i.next=5,u.db.deleteData("Messages",r);case 5:this.messages=this.messages.filter(function(p){return p.id!==r});case 6:case"end":return i.stop()}},d,this)}));function t(d){return l.apply(this,arguments)}return t}()},{key:"generateChatName",value:function(){var l=v()(o()().mark(function d(){var r,e,a,i,p,g,h;return o()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(r=JSON.parse(localStorage.getItem("openai_config")||"{}"),this.chat){c.next=3;break}throw new Error("Chat is not initialized");case 3:return e=[{role:"system",content:O.titleGeneratorPrompt}],a="system: ".concat(this.chat.systemPrompt,`
`),this.messages.forEach(function(f){a+="".concat(f.isUser?"user":"assistant",": ").concat(f.content,`
`)}),e.push({role:"user",content:a}),i={url:"".concat(r.end_point,"/v1/chat/completions"),method:"POST",headers:{},body:JSON.stringify({model:O.titleGeneratorModel,messages:e,stream:!1})},i.url.match("azure")?(i.url=r.end_point,i.headers={"Content-Type":"application/json","api-key":r.api_key}):i.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(r.api_key)},c.next=11,fetch(i.url,{method:i.method,headers:i.headers,body:i.body});case 11:return p=c.sent,c.next=14,p.json();case 14:return g=c.sent,h=g.choices[0].message.content,this.chat.title=h,c.next=19,u.db.updateData("Chats",this.chat);case 19:return c.abrupt("return",h);case 20:case"end":return c.stop()}},d,this)}));function t(){return l.apply(this,arguments)}return t}()}],[{key:"getChats",value:function(){var l=v()(o()().mark(function d(){return o()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.db.getAllDataByIndex("Chats","type",u.z.Chat);case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),console.error("Error getting chats",e.t0),e.abrupt("return",[]);case 10:case"end":return e.stop()}},d,null,[[0,6]])}));function t(){return l.apply(this,arguments)}return t}()}]),D}(re()(EventTarget)),ue=he}}]);
