"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[981],{9981:function(pe,Z,h){h.d(Z,{Z:function(){return le}});var K=h(64599),Q=h.n(K),L=h(15009),d=h.n(L),V=h(99289),v=h.n(V),X=h(12444),x=h.n(X),q=h(72004),_=h.n(q),ee=h(25098),z=h.n(ee),te=h(31996),ae=h.n(te),se=h(26037),re=h.n(se),ne=h(12665),ie=h.n(ne),he=h(9783),R=h.n(he),f=h(88001),P={titleGeneratorModel:"gpt-4o-mini",titleGeneratorPrompt:"You are a conversation management robot. What the user will send to you is the details of the conversation between the user and an AI. You need to generate a short title that can summarize the content based on the content of the conversation. Output only text, without quotes and markdown format"},ue=h(57632),u=h(41467),oe=function(de){ae()(k,de);var ce=re()(k);function k(o){var a;return x()(this,k),a=ce.call(this),R()(z()(a),"id",void 0),R()(z()(a),"chat",void 0),R()(z()(a),"botId",void 0),R()(z()(a),"messages",[]),o?a.id=o:a.id=(0,ue.Z)(),a}return _()(k,[{key:"setId",value:function(a){this.id=a}},{key:"setBot",value:function(a){this.botId=a}},{key:"init",value:function(){var o=v()(d()().mark(function l(s,e){var r,n,p;return d()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,u.db.getData("Chats",this.id);case 2:if(this.chat=i.sent,!(this.chat===null||this.chat===void 0)){i.next=15;break}if(this.chat={id:this.id,title:s===u.z.GenerateBot?"Generate Bot":"",createdAt:new Date,systemPrompt:s===u.z.GenerateBot?f.Qj:"",type:s||u.z.Chat,model:s===u.z.GenerateBot?e||f.K4:e||f.pk,maxDisplayRounds:s===u.z.GenerateBot?100:f.xf,maxMemoryRounds:s===u.z.GenerateBot?100:f.DI},!(this.botId&&this.chat.type===u.z.Chat)){i.next=11;break}return this.chat.botId=this.botId,i.next=9,u.db.getData("Bots",this.botId);case 9:r=i.sent,r&&(this.chat.systemPrompt=r.systemPrompt,this.chat.model=r.model,this.chat.maxDisplayRounds=r.maxDisplayRounds,this.chat.maxMemoryRounds=r.maxMemoryRounds);case 11:return i.next=13,u.db.addData("Chats",this.chat);case 13:i.next=20;break;case 15:return this.chat.maxDisplayRounds=((n=this.chat)===null||n===void 0?void 0:n.maxDisplayRounds)||f.xf,this.chat.maxMemoryRounds=((p=this.chat)===null||p===void 0?void 0:p.maxMemoryRounds)||f.DI,i.next=19,u.db.getAllDataByIndex("Messages","chatId",this.id);case 19:this.messages=i.sent.slice(-this.chat.maxDisplayRounds*2);case 20:case"end":return i.stop()}},l,this)}));function a(l,s){return o.apply(this,arguments)}return a}()},{key:"changeModel",value:function(){var o=v()(d()().mark(function l(s){return d()().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(this.chat){r.next=2;break}throw new Error("Chat is not initialized");case 2:return this.chat.model=s,r.next=5,u.db.updateData("Chats",this.chat);case 5:case"end":return r.stop()}},l,this)}));function a(l){return o.apply(this,arguments)}return a}()},{key:"renameChat",value:function(){var o=v()(d()().mark(function l(s){return d()().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(this.chat){r.next=2;break}throw new Error("Chat is not initialized");case 2:return this.chat.title=s,r.next=5,u.db.updateData("Chats",this.chat);case 5:case"end":return r.stop()}},l,this)}));function a(l){return o.apply(this,arguments)}return a}()},{key:"deleteChat",value:function(){var o=v()(d()().mark(function l(){return d()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.chat){e.next=2;break}throw new Error("Chat is not initialized");case 2:return e.next=4,u.db.deleteData("Chats",this.chat.id);case 4:return e.next=6,u.db.deleteDataByIndex("Messages","chatId",this.chat.id);case 6:case"end":return e.stop()}},l,this)}));function a(){return o.apply(this,arguments)}return a}()},{key:"sendMessage",value:function(){var o=v()(d()().mark(function l(s){var e,r,n,p=this,g,i,w,c,b,m,A,$,J,E,T,j,U,Y,F,D,H,W,B,N;return d()().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=JSON.parse(localStorage.getItem("openai_config")||"{}"),this.chat){t.next=3;break}throw new Error("Chat is not initialized");case 3:return w={chatId:this.chat.id,content:s,createdAt:new Date,isUser:!0},t.next=6,u.db.addData("Messages",w);case 6:return c=t.sent,w.id=parseInt(c.toString()),this.messages.push(w),this.messages.length>(((e=this.chat)===null||e===void 0?void 0:e.maxMemoryRounds)||f.DI)*2&&this.messages.shift(),this.dispatchEvent(new CustomEvent("userMessageId",{detail:c})),b=[{role:"system",content:this.chat.systemPrompt}],this.messages.slice(-(((r=this.chat)===null||r===void 0?void 0:r.maxMemoryRounds)||f.DI)*2).forEach(function(G){var M={role:G.isUser?"user":"assistant",content:G.content};b.push(M)}),m={url:"".concat(i.end_point,"/v1/chat/completions"),method:"POST",headers:{},body:JSON.stringify({model:this.chat.model,messages:b,stream:!0})},m.url.match("azure")?(m.url=i.end_point,m.headers={"Content-Type":"application/json","api-key":i.api_key}):m.url.match("cloudsway")?(m.url="".concat(i.end_point,"/chat/completions"),m.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(i.api_key)}):m.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(i.api_key)},t.next=17,fetch(m.url,{method:m.method,headers:m.headers,body:m.body});case 17:A=t.sent,$=(n=A.body)===null||n===void 0?void 0:n.getReader(),J=new TextDecoder("utf-8"),E="";case 21:return t.next=24,$.read();case 24:if(T=t.sent,j=T.done,U=T.value,!j){t.next=29;break}return t.abrupt("break",51);case 29:Y=J.decode(U,{stream:!0}),F=Y.split(`
`),D=Q()(F),t.prev=32,W=d()().mark(function G(){var M,O,y,S;return d()().wrap(function(I){for(;;)switch(I.prev=I.next){case 0:if(M=H.value,!M.startsWith("data: ")){I.next=9;break}if(O=M.slice(6),O!=="[DONE]"){I.next=6;break}return p.dispatchEvent(new CustomEvent("messageReceivedDone",{detail:E})),I.abrupt("return",1);case 6:y=function(){try{return JSON.parse(O)}catch(C){return{}}}(),S=function(){if(y!=null&&y.choices){var C;return y==null||(C=y.choices[0])===null||C===void 0||(C=C.delta)===null||C===void 0?void 0:C.content}return null}(),S&&(E+=S,p.dispatchEvent(new CustomEvent("messageReceived",{detail:S})));case 9:case"end":return I.stop()}},G)}),D.s();case 35:if((H=D.n()).done){t.next=41;break}return t.delegateYield(W(),"t0",37);case 37:if(!t.t0){t.next=39;break}return t.abrupt("break",41);case 39:t.next=35;break;case 41:t.next=46;break;case 43:t.prev=43,t.t1=t.catch(32),D.e(t.t1);case 46:return t.prev=46,D.f(),t.finish(46);case 49:t.next=21;break;case 51:return B={chatId:this.chat.id,content:E,createdAt:new Date,isUser:!1},t.next=54,u.db.addData("Messages",B);case 54:N=t.sent,B.id=parseInt(N.toString()),this.messages.push(B),this.messages.length>(((g=this.chat)===null||g===void 0?void 0:g.maxMemoryRounds)||f.DI)*2&&this.messages.shift(),this.dispatchEvent(new CustomEvent("assistantMessageId",{detail:N}));case 59:case"end":return t.stop()}},l,this,[[32,43,46,49]])}));function a(l){return o.apply(this,arguments)}return a}()},{key:"deleteMessage",value:function(){var o=v()(d()().mark(function l(s){var e;return d()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e=this.messages.find(function(p){return p.id===s}),e){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,u.db.deleteData("Messages",s);case 5:this.messages=this.messages.filter(function(p){return p.id!==s});case 6:case"end":return n.stop()}},l,this)}));function a(l){return o.apply(this,arguments)}return a}()},{key:"generateChatName",value:function(){var o=v()(d()().mark(function l(){var s,e,r,n,p,g,i;return d()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(s=JSON.parse(localStorage.getItem("openai_config")||"{}"),this.chat){c.next=3;break}throw new Error("Chat is not initialized");case 3:return e=[{role:"system",content:P.titleGeneratorPrompt}],r="system: ".concat(this.chat.systemPrompt,`
`),this.messages.forEach(function(b){r+="".concat(b.isUser?"user":"assistant",": ").concat(b.content,`
`)}),e.push({role:"user",content:r}),n={url:"".concat(s.end_point,"/v1/chat/completions"),method:"POST",headers:{},body:JSON.stringify({model:P.titleGeneratorModel,messages:e,stream:!1})},n.url.match("azure")?(n.url=s.end_point,n.headers={"Content-Type":"application/json","api-key":s.api_key}):n.url.match("cloudsway")?(n.url="".concat(s.end_point,"/chat/completions"),n.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(s.api_key)}):n.headers={"Content-Type":"application/json",Authorization:"Bearer ".concat(s.api_key)},c.next=11,fetch(n.url,{method:n.method,headers:n.headers,body:n.body});case 11:return p=c.sent,c.next=14,p.json();case 14:return g=c.sent,i=g.choices[0].message.content,this.chat.title=i,c.next=19,u.db.updateData("Chats",this.chat);case 19:return c.abrupt("return",i);case 20:case"end":return c.stop()}},l,this)}));function a(){return o.apply(this,arguments)}return a}()}],[{key:"getChats",value:function(){var o=v()(d()().mark(function l(){return d()().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u.db.getAllDataByIndex("Chats","type",u.z.Chat);case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),console.error("Error getting chats",e.t0),e.abrupt("return",[]);case 10:case"end":return e.stop()}},l,null,[[0,6]])}));function a(){return o.apply(this,arguments)}return a}()}]),k}(ie()(EventTarget)),le=oe}}]);
